{% extends 'base.html' %}

{% block title %}Adicionar Presente - Lista de Presentes{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 40px 0;
        margin: -20px -15px 30px;
        border-radius: 0 0 30px 30px;
    }

    .form-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        padding: 40px;
        max-width: 800px;
        margin: 0 auto;
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
    }

    .form-label i {
        color: #11998e;
    }

    .form-control:focus, .form-select:focus {
        border-color: #11998e;
        box-shadow: 0 0 0 0.2rem rgba(17, 153, 142, 0.25);
    }

    .btn-submit {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        border: none;
        color: white;
        padding: 15px 40px;
        font-weight: 600;
        font-size: 1.1rem;
        border-radius: 50px;
        transition: all 0.3s;
        box-shadow: 0 5px 20px rgba(17, 153, 142, 0.3);
    }

    .btn-submit:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(17, 153, 142, 0.5);
        color: white;
    }

    .btn-cancel {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        color: #6c757d;
        padding: 15px 40px;
        font-weight: 600;
        font-size: 1.1rem;
        border-radius: 50px;
        transition: all 0.3s;
    }

    .btn-cancel:hover {
        background: #e9ecef;
        border-color: #adb5bd;
        color: #495057;
    }

    .image-preview-container {
        margin-top: 15px;
        text-align: center;
    }

    .image-preview {
        max-width: 100%;
        max-height: 300px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        display: none;
        margin: 15px auto;
    }

    .image-placeholder {
        width: 100%;
        height: 200px;
        background: linear-gradient(135deg, #11998e20 0%, #38ef7d20 100%);
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: #11998e;
        margin-bottom: 15px;
        transition: all 0.3s;
        cursor: pointer;
        border: 3px dashed #11998e40;
    }

    .image-placeholder:hover {
        background: linear-gradient(135deg, #11998e30 0%, #38ef7d30 100%);
        border-color: #11998e;
    }

    .image-placeholder i {
        font-size: 3rem;
        margin-bottom: 10px;
    }

    .form-tips {
        background: #e7f9f5;
        border-left: 4px solid #11998e;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
    }

    .form-tips h5 {
        color: #11998e;
        margin-bottom: 15px;
    }

    .form-tips ul {
        margin-bottom: 0;
        padding-left: 20px;
    }

    .form-tips li {
        margin-bottom: 8px;
        color: #495057;
    }

    .character-counter {
        font-size: 0.85rem;
        color: #6c757d;
        text-align: right;
        margin-top: 5px;
    }

    .input-icon {
        position: relative;
    }

    .input-icon i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #adb5bd;
        pointer-events: none;
    }

    .currency-input {
        padding-left: 40px !important;
    }

    .currency-symbol {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #28a745;
        font-weight: 600;
        font-size: 1.1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1 class="mb-0">
            <i class="bi bi-plus-circle-fill me-2"></i>
            Adicionar Novo Presente
        </h1>
        <p class="mb-0 mt-2">Preencha os detalhes do presente que você deseja</p>
    </div>
</div>

<div class="container">
    <div class="form-card">
        <div class="form-tips">
            <h5>
                <i class="bi bi-lightbulb-fill"></i>
                Dicas para um bom cadastro
            </h5>
            <ul>
                <li><strong>Descrição clara:</strong> Seja específico sobre modelo, cor, tamanho, etc.</li>
                <li><strong>Adicione uma imagem:</strong> Fotos ajudam os outros a entenderem melhor</li>
                <li><strong>Inclua o link:</strong> Facilita para quem for comprar</li>
                <li><strong>Preço estimado:</strong> Ajuda a IA a encontrar opções similares</li>
            </ul>
        </div>

        <form method="post" enctype="multipart/form-data" novalidate id="presente-form">
            {% csrf_token %}

            <div class="mb-4">
                <label for="{{ form.descricao.id_for_label }}" class="form-label">
                    <i class="bi bi-card-text"></i> Descrição do Presente *
                </label>
                {{ form.descricao }}
                <div class="character-counter">
                    <span id="char-count">0</span> caracteres
                </div>
                {% if form.descricao.errors %}
                    <div class="text-danger small mt-1">{{ form.descricao.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="mb-4">
                <label for="{{ form.url_imagem.id_for_label }}" class="form-label">
                    <i class="bi bi-image"></i> Imagem do Presente
                </label>

                <!-- Campo para URL da imagem -->
                <div class="input-group mb-3">
                    {{ form.url_imagem }}
                    <button class="btn btn-outline-secondary" type="button" id="load-from-url" title="Carregar imagem da URL">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <small class="form-text text-muted mb-3 d-block">
                    <i class="bi bi-info-circle"></i> Cole a URL de uma imagem ou pressione Ctrl+V para colar uma imagem
                </small>

                <!-- Área de upload -->
                <div class="image-placeholder" id="drop-area" onclick="document.getElementById('{{ form.imagem.id_for_label }}').click();">
                    <i class="bi bi-cloud-upload"></i>
                    <p class="mb-0"><strong>Clique para fazer upload</strong></p>
                    <small class="text-muted">ou arraste uma imagem / Ctrl+V para colar</small>
                </div>
                {{ form.imagem }}

                <!-- Preview da imagem -->
                <img id="image-preview" class="image-preview" alt="Preview">
                <div class="image-preview-container" id="preview-container" style="display: none;">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeImage()">
                        <i class="bi bi-trash"></i> Remover imagem
                    </button>
                </div>

                {% if form.imagem.errors %}
                    <div class="text-danger small mt-1">{{ form.imagem.errors.0 }}</div>
                {% endif %}
                {% if form.url_imagem.errors %}
                    <div class="text-danger small mt-1">{{ form.url_imagem.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="row">
                <div class="col-md-6 mb-4">
                    <label for="{{ form.url.id_for_label }}" class="form-label">
                        <i class="bi bi-link-45deg"></i> Link do Produto
                    </label>
                    <div class="input-icon">
                        {{ form.url }}
                        <i class="bi bi-box-arrow-up-right"></i>
                    </div>
                    <small class="form-text text-muted">
                        Cole o link de onde você viu o produto
                    </small>
                    {% if form.url.errors %}
                        <div class="text-danger small mt-1">{{ form.url.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="col-md-6 mb-4">
                    <label for="{{ form.preco.id_for_label }}" class="form-label">
                        <i class="bi bi-cash-coin"></i> Preço Estimado
                    </label>
                    <div class="position-relative">
                        <span class="currency-symbol">R$</span>
                        {{ form.preco }}
                    </div>
                    <small class="form-text text-muted">
                        Preço aproximado do produto
                    </small>
                    {% if form.preco.errors %}
                        <div class="text-danger small mt-1">{{ form.preco.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="d-flex gap-3 justify-content-center mt-5">
                <a href="{% url 'meus_presentes' %}" class="btn btn-cancel">
                    <i class="bi bi-x-circle me-2"></i>
                    Cancelar
                </a>
                <button type="submit" class="btn btn-submit">
                    <i class="bi bi-check-circle me-2"></i>
                    Adicionar Presente
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Preview de imagem
    const imageInput = document.getElementById('{{ form.imagem.id_for_label }}');
    const imagePreview = document.getElementById('image-preview');
    const previewContainer = document.getElementById('preview-container');
    const placeholder = document.querySelector('.image-placeholder');
    const urlImagemInput = document.getElementById('url-imagem-input');
    const loadFromUrlBtn = document.getElementById('load-from-url');

    // Função para exibir preview
    function showImagePreview(src) {
        imagePreview.src = src;
        imagePreview.style.display = 'block';
        previewContainer.style.display = 'block';
        placeholder.style.display = 'none';
    }

    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                showImagePreview(event.target.result);
            };
            reader.readAsDataURL(file);
        }
    });

    // Carregar imagem de URL
    async function loadImageFromUrl(url) {
        if (!url || !url.trim()) {
            alert('Por favor, insira uma URL válida');
            return;
        }

        // Mostrar loading
        loadFromUrlBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        loadFromUrlBtn.disabled = true;

        try {
            // Fazer fetch da imagem através de um proxy CORS ou direto
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error('Não foi possível carregar a imagem');
            }

            const blob = await response.blob();

            // Verificar se é uma imagem
            if (!blob.type.startsWith('image/')) {
                throw new Error('URL não é uma imagem válida');
            }

            // Criar arquivo a partir do blob
            const filename = url.split('/').pop().split('?')[0] || 'imagem.jpg';
            const file = new File([blob], filename, { type: blob.type });

            // Criar DataTransfer para simular upload de arquivo
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            imageInput.files = dataTransfer.files;

            // Disparar evento de change
            const event = new Event('change', { bubbles: true });
            imageInput.dispatchEvent(event);

            // Limpar campo de URL após carregar
            // urlImagemInput.value = '';

        } catch (error) {
            console.error('Erro ao carregar imagem:', error);
            alert('Erro ao carregar imagem da URL: ' + error.message + '\n\nTente fazer download da imagem e fazer upload direto.');
        } finally {
            // Restaurar botão
            loadFromUrlBtn.innerHTML = '<i class="bi bi-download"></i>';
            loadFromUrlBtn.disabled = false;
        }
    }

    // Evento do botão de carregar da URL
    loadFromUrlBtn.addEventListener('click', function() {
        loadImageFromUrl(urlImagemInput.value);
    });

    // Carregar ao pressionar Enter no campo de URL
    urlImagemInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            loadImageFromUrl(this.value);
        }
    });

    // PASTE DE IMAGEM (Ctrl+V)
    document.addEventListener('paste', function(e) {
        const items = e.clipboardData.items;

        for (let i = 0; i < items.length; i++) {
            // Verificar se é uma imagem
            if (items[i].type.indexOf('image') !== -1) {
                e.preventDefault();

                const blob = items[i].getAsFile();
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(blob);
                imageInput.files = dataTransfer.files;

                // Disparar evento de change
                const event = new Event('change', { bubbles: true });
                imageInput.dispatchEvent(event);

                break;
            }
            // Verificar se é texto (pode ser URL)
            else if (items[i].type === 'text/plain') {
                items[i].getAsString(function(text) {
                    // Verificar se é uma URL de imagem
                    const urlPattern = /^https?:\/\/.+\.(jpg|jpeg|png|gif|webp|svg)(\?.*)?$/i;
                    if (urlPattern.test(text.trim())) {
                        urlImagemInput.value = text.trim();
                        loadImageFromUrl(text.trim());
                    }
                });
            }
        }
    });

    // Drag and drop
    const dropArea = placeholder;

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropArea.style.borderColor = '#11998e';
        dropArea.style.background = 'linear-gradient(135deg, #11998e30 0%, #38ef7d30 100%)';
    }

    function unhighlight(e) {
        dropArea.style.borderColor = '#11998e40';
        dropArea.style.background = 'linear-gradient(135deg, #11998e20 0%, #38ef7d20 100%)';
    }

    dropArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        imageInput.files = files;
        const event = new Event('change', { bubbles: true });
        imageInput.dispatchEvent(event);
    }

    function removeImage() {
        imageInput.value = '';
        urlImagemInput.value = '';
        imagePreview.style.display = 'none';
        previewContainer.style.display = 'none';
        placeholder.style.display = 'flex';
    }

    // Contador de caracteres
    const descricaoInput = document.getElementById('{{ form.descricao.id_for_label }}');
    const charCount = document.getElementById('char-count');

    descricaoInput.addEventListener('input', function() {
        charCount.textContent = this.value.length;
    });

    // Formatar input de preço
    const precoInput = document.getElementById('{{ form.preco.id_for_label }}');
    if (precoInput) {
        precoInput.classList.add('currency-input');
    }
</script>
{% endblock %}
