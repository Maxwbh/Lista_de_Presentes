name: Deploy to Render

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify deployment start
        run: |
          echo "ğŸš€ Iniciando deploy para Render..."
          echo "ğŸ“¦ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ’¬ Mensagem: ${{ github.event.head_commit.message }}"

      - name: Trigger Render deployment
        run: |
          echo "ğŸ“¡ Render farÃ¡ deploy automÃ¡tico ao detectar push no branch master"
          echo "âœ… Push detectado, aguarde o build no Render Dashboard"
          echo "ğŸ”— https://dashboard.render.com/"

      - name: Wait for deployment
        run: |
          echo "â³ Aguardando 30 segundos para Render iniciar o build..."
          sleep 30

      - name: Check deployment status
        continue-on-error: true
        run: |
          echo "ğŸ” Verificando status do deployment..."

          # Tentar fazer ping no health check
          for i in {1..10}; do
            echo "Tentativa $i de 10..."
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://lista-presentes-1iwb.onrender.com/health/ || echo "000")

            if [ "$RESPONSE" -eq 200 ]; then
              echo "âœ… AplicaÃ§Ã£o estÃ¡ respondendo! Status: $RESPONSE"
              exit 0
            else
              echo "â³ Aguardando... Status: $RESPONSE"
              sleep 30
            fi
          done

          echo "âš ï¸ NÃ£o foi possÃ­vel confirmar o deploy. Verifique o Render Dashboard."
          exit 1

      - name: Deployment summary
        if: always()
        run: |
          echo "ğŸ“Š Resumo do Deploy:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ URL: https://lista-presentes-1iwb.onrender.com"
          echo "ğŸ“‹ VersÃ£o: $(cat VERSION 2>/dev/null || echo 'unknown')"
          echo "ğŸ“… Data: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
